<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.P.C. PRO | NEURAL COMMAND</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;600;700&family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --sidebar-width: 260px;
            --primary: #00f3ff;
            --accent: #00ff9d;
            --danger: #ff0055;
            --warning: #ffd700;
            --surface: #0f1115;
            --surface-hover: #1a1d24;
            --border: 1px solid #2a2d35;
            --text-main: #e0f7ff;
            --text-dim: #6b7280;
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #0a0a0a;
            border-right: var(--border);
            display: flex; flex-direction: column; padding: 20px;
            z-index: 200; /* Ensure sidebar is above */
        }

        .logo-area {
            margin-bottom: 40px; display: flex; align-items: center; gap: 12px;
            color: white; font-family: 'Orbitron'; font-weight: 800; font-size: 18px; letter-spacing: 1px;
        }
        .logo-icon {
            width: 36px; height: 36px; background: var(--primary); color: black;
            display: flex; align-items: center; justify-content: center; border-radius: 8px;
        }

        .nav-group { margin-bottom: 25px; }
        .nav-label { color: var(--text-dim); font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; padding-left: 10px; letter-spacing: 1px; }
        
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            color: #9ca3af; text-decoration: none; border-radius: 8px;
            transition: all 0.2s; cursor: pointer; margin-bottom: 4px;
            font-family: 'Inter'; font-weight: 500; font-size: 14px;
        }
        .nav-item:hover { background: var(--surface-hover); color: white; }
        .nav-item.active { background: rgba(0, 243, 255, 0.1); color: var(--primary); border: 1px solid rgba(0, 243, 255, 0.2); }
        .nav-item i { font-size: 20px; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; display: flex; flex-direction: column; position: relative;
            background: radial-gradient(circle at 10% 10%, rgba(0, 243, 255, 0.02) 0%, transparent 40%);
            overflow: hidden;
        }

        .top-bar {
            height: 64px; border-bottom: var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
            background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(10px);
            z-index: 100;
        }

        .view-section { 
            display: none; 
            height: calc(100vh - 64px); /* Full height minus top bar */
            overflow-y: auto; 
            padding: 20px; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        .view-section.active { display: block; opacity: 1; }

        /* --- DASHBOARD GRID FIXED --- */
        .dash-grid {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 180px 1fr 140px; /* Explicit rows */
            gap: 20px; 
            height: 100%;
            padding-bottom: 20px;
        }

        .card {
            background: var(--surface); border: var(--border); border-radius: 12px;
            padding: 20px; position: relative; display: flex; flex-direction: column;
            overflow: hidden;
        }
        .card-header {
            font-family: 'JetBrains Mono'; font-weight: 700; color: var(--text-dim);
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
        }

        /* Explicit Placement to prevent blocking */
        #card-sensors { grid-column: 1 / 2; grid-row: 1 / 2; }
        #card-neural  { grid-column: 3 / 4; grid-row: 1 / 2; }
        #card-logs    { grid-column: 1 / 2; grid-row: 2 / 4; } /* Taller logs on left */
        #card-viz     { grid-column: 2 / 3; grid-row: 1 / 3; } /* Center big viz */
        #card-stats   { grid-column: 2 / 4; grid-row: 3 / 4; } /* Bottom right span */

        /* Metric Cards */
        .metric-val { font-size: 32px; font-family: 'Orbitron'; font-weight: 700; color: white; }
        .metric-unit { font-size: 12px; color: var(--text-dim); margin-left: 5px; }

        /* Neural Viz */
        .neural-viz {
            display: flex; justify-content: space-between; align-items: center;
            height: 100%; position: relative;
        }
        .layer { display: flex; flex-direction: column; justify-content: space-around; height: 100%; }
        .node {
            width: 10px; height: 10px; border-radius: 50%; background: #333;
            border: 1px solid #555; transition: all 0.1s; position: relative; z-index: 2;
        }
        .node.active { background: var(--primary); box-shadow: 0 0 10px var(--primary); border-color: white; transform: scale(1.3); }

        /* Plant Viz */
        .viz-card {
            background: #000; border: 1px solid #333;
            display: flex; align-items: center; justify-content: center; position: relative;
            overflow: hidden;
        }
        #plant-wrapper { perspective: 1000px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #plant-container { width: 20px; height: 300px; transform-style: preserve-3d; animation: spinPlant 20s infinite linear; }
        @keyframes spinPlant { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        .stem { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 12px; height: 100%; background: var(--accent); border-radius: 6px; }
        .leaf { position: absolute; width: 80px; height: 40px; background: var(--accent); border-radius: 50px 0; opacity: 0.9; transform-origin: 0 50%; transition: all 0.5s; }
        
        /* Inference Log */
        .inf-log { font-family: 'JetBrains Mono'; font-size: 11px; color: #666; height: 100%; overflow: hidden; position: relative; }
        .inf-line { margin-bottom: 6px; display: flex; gap: 10px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .inf-time { color: #444; min-width: 60px; }
        .inf-data { color: #aaa; }
        .inf-tensor { color: var(--accent); }

        /* --- OTHER VIEWS --- */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 400px; }
        .training-console { 
            background: #000; border: 1px solid #333; border-radius: 8px; padding: 20px; 
            font-family: 'JetBrains Mono'; color: #0f0; height: 500px; overflow-y: auto;
        }

        /* --- PRO CONFIG PAGE --- */
        .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        .model-card {
            background: var(--surface); border: var(--border); border-radius: 12px; padding: 20px;
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .model-card:hover { border-color: #444; background: var(--surface-hover); }
        .model-card.selected { border-color: var(--primary); background: rgba(0, 243, 255, 0.05); }
        
        .badge {
            padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;
            background: #222; color: #888; display: inline-block; margin-right: 5px;
        }
        .badge.pro { background: var(--primary); color: black; }

        .slider-group { margin-bottom: 20px; }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #ccc; }
        .slider-val { color: var(--primary); font-family: 'JetBrains Mono'; }
        input[type="range"] {
            width: 100%; height: 4px; background: #333; border-radius: 2px; appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 16px; height: 16px; background: white; border-radius: 50%; cursor: pointer; transition: 0.2s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { background: var(--primary); transform: scale(1.2); }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="logo-area">
            <div class="logo-icon"><i class="material-icons">hub</i></div>
            <div>
                <div>NEURAL.PLANT</div>
                <div style="font-size: 10px; color: var(--text-dim); font-weight: 400;">PRO EDITION v2.5</div>
            </div>
        </div>

        <div class="nav-group">
            <div class="nav-label">Platform</div>
            <div class="nav-item active" onclick="nav('dashboard', this)"><i class="material-icons">dashboard</i>Dashboard</div>
            <div class="nav-item" onclick="nav('analytics', this)"><i class="material-icons">analytics</i>Analytics</div>
        </div>

        <div class="nav-group">
            <div class="nav-label">Intelligence</div>
            <div class="nav-item" onclick="nav('config', this)"><i class="material-icons">tune</i>Model Config</div>
            <div class="nav-item" onclick="nav('training', this)"><i class="material-icons">model_training</i>Training</div>
        </div>
        
        <div style="margin-top: auto; border: 1px solid #333; border-radius: 8px; padding: 15px; background: #0f0f0f;">
            <div style="font-size: 11px; color: #888; margin-bottom: 5px;">GPU STATUS</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold; color: white;">RTX 5090</span>
                <span style="color: var(--accent); font-size: 10px;">● ACTIVE</span>
            </div>
            <div style="width: 100%; height: 4px; background: #333; margin-top: 8px; border-radius: 2px;">
                <div style="width: 45%; height: 100%; background: var(--primary);"></div>
            </div>
            <div style="font-size: 10px; color: #666; margin-top: 4px;">45% Load • 42°C</div>
        </div>
    </div>

    <!-- MAIN -->
    <div class="main-content">
        <div class="top-bar">
            <div id="page-title" style="font-family: 'Orbitron'; font-weight: 700; font-size: 16px;">MISSION CONTROL</div>
            <div style="display: flex; gap: 15px;">
                <button onclick="togglePlay()" id="playBtn" style="background: var(--primary); color: black; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 700; cursor: pointer;">START STREAM</button>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="dashboard" class="view-section active">
            <div class="dash-grid">
                
                <!-- 1. Metrics (Top Left) -->
                <div class="card" id="card-sensors">
                    <div class="card-header">SENSORS <i class="material-icons">sensors</i></div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div>
                            <div style="font-size: 10px; color: #888;">MOISTURE</div>
                            <div style="display: flex; align-items: baseline;"><span class="metric-val" id="val-moisture">0</span><span class="metric-unit">%</span></div>
                            <div style="width:100%; height:3px; background:#333;"><div id="bar-moisture" style="width:0%; height:100%; background:var(--primary);"></div></div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: #888;">TEMP</div>
                            <div style="display: flex; align-items: baseline;"><span class="metric-val" id="val-temp">0</span><span class="metric-unit">°C</span></div>
                            <div style="width:100%; height:3px; background:#333;"><div id="bar-temp" style="width:0%; height:100%; background:#ff9d00;"></div></div>
                        </div>
                    </div>
                </div>

                <!-- 2. Neural Viz (Top Right) -->
                <div class="card" id="card-neural">
                    <div class="card-header">
                        LIVE INFERENCE
                        <span style="color: var(--accent); font-size: 10px;">● 12ms</span>
                    </div>
                    <div class="neural-viz" id="neural-net">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- 3. Logs (Left Col - Spans Down) -->
                <div class="card" id="card-logs">
                    <div class="card-header">DECISION STREAM</div>
                    <div class="inf-log" id="inf-log">
                        <div class="inf-line"><span class="inf-time">INIT</span><span class="inf-data">SYSTEM READY...</span></div>
                    </div>
                </div>

                <!-- 4. Main Viz (Center) -->
                <div class="viz-card" id="card-viz">
                    <div style="position: absolute; top: 20px; left: 20px; font-family: 'Orbitron'; color: #333; font-size: 32px; font-weight: 900; z-index: 0;">PLANT.OS</div>
                    
                    <div id="plant-wrapper">
                        <div id="plant-container">
                            <div class="stem"></div>
                            <div class="leaf L1" style="bottom: 30%; left: 50%; transform: rotateY(0deg) rotateZ(-45deg);"></div>
                            <div class="leaf R1" style="bottom: 25%; left: 50%; transform: rotateY(180deg) rotateZ(-45deg);"></div>
                            <div class="leaf L2" style="bottom: 50%; left: 50%; transform: rotateY(90deg) rotateZ(-30deg);"></div>
                            <div class="leaf R2" style="bottom: 45%; left: 50%; transform: rotateY(270deg) rotateZ(-30deg);"></div>
                        </div>
                    </div>
                    
                    <div style="position: absolute; bottom: 30px; width: 100%; text-align: center;">
                        <div style="font-size: 10px; color: #666; letter-spacing: 2px; margin-bottom: 5px;">PREDICTED HEALTH</div>
                        <div id="val-health" style="font-size: 50px; font-weight: 900; color: var(--accent); text-shadow: 0 0 30px rgba(0,255,157,0.3);">98%</div>
                    </div>
                    <div id="lamp-overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent); pointer-events: none; opacity: 0; transition: 0.3s;"></div>
                </div>

                <!-- 5. Bottom Stats (Bottom Right Span) -->
                <div class="card" id="card-stats">
                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; height: 100%;">
                         <div>
                             <div class="card-header">WATER EFFICIENCY</div>
                             <div style="font-size: 24px; color: var(--primary);" id="stats-water">0.0 L</div>
                         </div>
                         <div>
                             <div class="card-header">ENERGY EFFICIENCY</div>
                             <div style="font-size: 24px; color: var(--warning);" id="stats-energy">0.0 kWh</div>
                         </div>
                     </div>
                </div>
            </div>
        </div>

        <!-- VIEW: ANALYTICS (FIXED: Now exists) -->
        <div id="analytics" class="view-section">
            <h2 style="font-family: 'Orbitron'; margin-bottom: 20px;">HISTORICAL ANALYSIS</h2>
            <div class="analytics-grid">
                <div class="card">
                    <div class="card-header">HEALTH TRENDS (7 DAYS)</div>
                    <div style="flex:1"><canvas id="analyticsChart1"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header">RESOURCE DISTRIBUTION</div>
                    <div style="flex:1"><canvas id="analyticsChart2"></canvas></div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">DETAILED EPISODE REPORT</div>
                <table style="width: 100%; font-size: 12px; color: #aaa; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #333; text-align: left;">
                        <th style="padding: 10px;">EPISODE ID</th>
                        <th>DURATION</th>
                        <th>AVG HEALTH</th>
                        <th>WATER USED</th>
                        <th>REWARD</th>
                    </tr>
                    <tr style="border-bottom: 1px solid #222;">
                        <td style="padding: 10px; color: var(--primary);">#EP-2024-001</td>
                        <td>48h 12m</td>
                        <td>98.5%</td>
                        <td>1.2L</td>
                        <td style="color: var(--accent);">+450.2</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #222;">
                        <td style="padding: 10px; color: var(--primary);">#EP-2024-002</td>
                        <td>24h 00m</td>
                        <td>99.1%</td>
                        <td>0.8L</td>
                        <td style="color: var(--accent);">+210.5</td>
                    </tr>
                     <tr style="border-bottom: 1px solid #222;">
                        <td style="padding: 10px; color: var(--primary);">#EP-2024-003</td>
                        <td>72h 30m</td>
                        <td>97.8%</td>
                        <td>2.1L</td>
                        <td style="color: var(--accent);">+680.1</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- VIEW: CONFIG -->
        <div id="config" class="view-section">
            <h2 style="font-family: 'Orbitron'; margin-bottom: 30px;">MODEL CONFIGURATION</h2>
            <div class="config-grid" style="margin-bottom: 40px;">
                <div class="model-card selected" onclick="selectModel(this, 'ppo')">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold; font-family: 'Orbitron';">PPO-RESNET</span>
                        <span class="badge pro">RECOMMENDED</span>
                    </div>
                    <div style="font-size: 12px; color: #888; margin-bottom: 15px; line-height: 1.5;">Proximal Policy Optimization with Residual connections.</div>
                </div>
                <div class="model-card" onclick="selectModel(this, 'dqn')">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold; font-family: 'Orbitron';">DQN-DUELING</span>
                        <span class="badge">LEGACY</span>
                    </div>
                    <div style="font-size: 12px; color: #888; margin-bottom: 15px; line-height: 1.5;">Deep Q-Network with Dueling architecture.</div>
                </div>
                <div class="model-card" onclick="selectModel(this, 'sac')">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold; font-family: 'Orbitron';">SAC-ENTROPY</span>
                        <span class="badge pro">EXPERIMENTAL</span>
                    </div>
                    <div style="font-size: 12px; color: #888; margin-bottom: 15px; line-height: 1.5;">Soft Actor-Critic. Maximizes entropy.</div>
                </div>
            </div>
            
            <h2 style="font-family: 'Orbitron'; margin-bottom: 20px;">HYPERPARAMETERS</h2>
            <div class="config-grid">
                <div class="card">
                    <div class="card-header">TRAINING DYNAMICS</div>
                    <div class="slider-group"><div class="slider-label"><span>Learning Rate</span> <span class="slider-val">3e-4</span></div><input type="range" min="1" max="100" value="30"></div>
                    <div class="slider-group"><div class="slider-label"><span>Gamma</span> <span class="slider-val">0.99</span></div><input type="range" min="90" max="99" value="99"></div>
                </div>
                <div class="card">
                    <div class="card-header">CONSTRAINTS</div>
                    <div class="slider-group"><div class="slider-label"><span>Clip Range</span> <span class="slider-val">0.2</span></div><input type="range" min="1" max="5" value="2"></div>
                    <div class="slider-group"><div class="slider-label"><span>Entropy Coeff</span> <span class="slider-val">0.01</span></div><input type="range" min="0" max="10" value="1"></div>
                </div>
            </div>
        </div>

        <!-- VIEW: TRAINING (FIXED: Now exists) -->
        <div id="training" class="view-section">
            <h2 style="font-family: 'Orbitron'; margin-bottom: 20px;">TRAINING CONSOLE</h2>
            <div class="training-console" id="train-console">
                <div>> Initializing environment wrappers... OK</div>
                <div>> Loading CUDA drivers... OK (Device: RTX 5090)</div>
                <div>> Allocating memory buffers... 4096MB OK</div>
                <div>> Starting training loop [Epoch 0/1000]</div>
                <div style="margin-top: 10px; color: #888;">Waiting for command...</div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="startTraining()" style="background: var(--primary); border: none; padding: 10px 20px; font-weight: bold; cursor: pointer;">START TRAINING</button>
                <button onclick="stopTraining()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer;">ABORT</button>
            </div>
        </div>

    </div>

    <script>
        let RAW_DATA = null;
        let step = 0;
        let isPlaying = false;
        let intervalId = null;
        let currentPolicy = 'ppo';
        let totalWater = 0;
        let totalEnergy = 0;
        
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                RAW_DATA = await response.json();
                if(RAW_DATA.error) {
                    // alert(RAW_DATA.error);
                    console.warn("Using mock data");
                    // Mock data if fetch fails
                    RAW_DATA = { 'ppo': { t: Array.from({length:100}, (_,i)=>i), moisture: Array(100).fill(0.5), temperature: Array(100).fill(25), health: Array(100).fill(98), water: Array(100).fill(0), lamp: Array(100).fill(0) }};
                }
                updateSim(0);
                initAnalytics();
            } catch(e) {
                console.error("Failed to load data", e);
            }
        }
        
        // --- NAVIGATION ---
        function nav(id, el) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            const titles = {'dashboard': 'MISSION CONTROL', 'config': 'MODEL CONFIGURATION', 'analytics': 'ANALYTICS & METRICS', 'training': 'TRAINING OPERATIONS'};
            document.getElementById('page-title').innerText = titles[id] || 'SYSTEM';
        }
        
        function selectModel(el, model) {
            document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        // --- DASHBOARD LOGIC ---
        function initNeuralViz() {
            const container = document.getElementById('neural-net');
            const layers = [3, 4, 4, 2];
            layers.forEach((count, lIdx) => {
                const layerDiv = document.createElement('div');
                layerDiv.className = 'layer';
                for(let i=0; i<count; i++) {
                    const node = document.createElement('div');
                    node.className = 'node';
                    node.id = `node-${lIdx}-${i}`;
                    layerDiv.appendChild(node);
                }
                container.appendChild(layerDiv);
            });
        }

        function animateNet() {
            document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
            // Random activation
            for(let i=0; i<5; i++) {
                const l = Math.floor(Math.random()*4);
                const n = Math.floor(Math.random()*2);
                const el = document.getElementById(`node-${l}-${n}`);
                if(el) el.classList.add('active');
            }
        }

        function updateSim(idx) {
            if(!RAW_DATA) return;
            const d = RAW_DATA[currentPolicy] || RAW_DATA['ppo']; // fallback
            if(!d || idx >= d.t.length) return;
            
            document.getElementById('val-moisture').innerText = (d.moisture[idx]*100).toFixed(0);
            document.getElementById('bar-moisture').style.width = (d.moisture[idx]*100) + '%';
            document.getElementById('val-temp').innerText = d.temperature[idx].toFixed(1);
            document.getElementById('bar-temp').style.width = ((d.temperature[idx]/40)*100) + '%';
            document.getElementById('val-health').innerText = d.health[idx].toFixed(0) + '%';
            
            if(d.water[idx] > 0) totalWater += d.water[idx];
            document.getElementById('stats-water').innerText = (totalWater/1000).toFixed(1) + ' L';
            
            // Calculate energy based on Lamp Usage
            if(d.lamp[idx] > 0) totalEnergy += 0.05; // 0.05 kWh per tick for demo
            document.getElementById('stats-energy').innerText = totalEnergy.toFixed(1) + ' kWh';

            if(d.water[idx] > 0) log(`Inference: ACTION_WATER [Prob: ${(0.8 + Math.random()*0.2).toFixed(2)}]`);
            
            animateNet();
        }
        
        function log(msg) {
            const c = document.getElementById('inf-log');
            const l = document.createElement('div');
            l.className = 'inf-line';
            l.innerHTML = `<span class="inf-time">${new Date().toLocaleTimeString().split(' ')[0]}</span><span class="inf-tensor">${msg}</span>`;
            c.prepend(l);
            if(c.children.length > 10) c.lastChild.remove();
        }

        function togglePlay() {
            if(isPlaying) {
                clearInterval(intervalId); isPlaying=false;
                document.getElementById('playBtn').innerText = "RESUME";
            } else {
                isPlaying=true;
                document.getElementById('playBtn').innerText = "PAUSE";
                intervalId = setInterval(() => {
                    step++;
                    if(!RAW_DATA || step >= 100) step=0; // loop
                    updateSim(step);
                }, 100);
            }
        }

        // --- ANALYTICS ---
        function initAnalytics() {
            const ctx1 = document.getElementById('analyticsChart1').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Plant Health',
                        data: [95, 96, 94, 98, 97, 98, 99],
                        borderColor: '#00ff9d',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#222' } }, x: { grid: { display: false } } } }
            });

            const ctx2 = document.getElementById('analyticsChart2').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Water', 'Light', 'Nutrients'],
                    datasets: [{
                        data: [45, 30, 25],
                        backgroundColor: ['#00f3ff', '#ffd700', '#ff0055'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- TRAINING ---
        function startTraining() {
            const term = document.getElementById('train-console');
            term.innerHTML += `<div>> Training started...</div>`;
            let epoch = 0;
            const tId = setInterval(() => {
                epoch++;
                const loss = (Math.random() * 0.5).toFixed(4);
                const reward = (Math.random() * 100).toFixed(1);
                term.innerHTML += `<div>[Epoch ${epoch}] Loss: ${loss} | Avg Reward: ${reward}</div>`;
                term.scrollTop = term.scrollHeight;
                if(epoch > 5) clearInterval(tId);
            }, 500);
        }

        function stopTraining() {
             const term = document.getElementById('train-console');
             term.innerHTML += `<div style="color:red">> Training aborted by user.</div>`;
        }

        initNeuralViz();
        loadData();

    </script>
</body>
</html>
